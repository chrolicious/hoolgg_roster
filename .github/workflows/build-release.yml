name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

permissions:
  contents: write  # Required to create releases

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt pyinstaller

      - name: Build Flask app with PyInstaller
        run: pyinstaller app.spec --distpath dist-app

      - name: Download Python Embedded
        run: |
          mkdir electron\python-embedded
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.7/python-3.11.7-embed-amd64.zip" -OutFile python-embed.zip
          Expand-Archive python-embed.zip -DestinationPath electron\python-embedded
          Remove-Item python-embed.zip
        shell: powershell

      - name: Configure embedded Python for pip
        run: |
          $pthFile = "electron\python-embedded\python311._pth"
          (Get-Content $pthFile) -replace '#import site', 'import site' | Set-Content $pthFile
        shell: powershell

      - name: Install pip in embedded Python
        run: |
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile electron\python-embedded\get-pip.py
          electron\python-embedded\python.exe electron\python-embedded\get-pip.py
        shell: powershell

      - name: Install Flask in embedded Python
        run: |
          electron\python-embedded\python.exe -m pip install Flask requests
        shell: powershell

      - name: Verify PyInstaller output
        run: |
          if (!(Test-Path "dist-app\app.exe")) {
            Write-Host "ERROR: PyInstaller did not produce dist-app\app.exe"
            Get-ChildItem -Path . -Filter "*.exe" -Recurse -Depth 2 | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          Write-Host "OK: dist-app\app.exe exists ($(("{0:N2}" -f ((Get-Item 'dist-app\app.exe').Length / 1MB))) MB)"
        shell: powershell

      - name: Install Electron dependencies
        working-directory: electron
        run: npm install

      - name: Build Electron app
        working-directory: electron
        run: npm run build:publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify app-resources were bundled
        run: |
          $dir = "electron\app-resources"
          $required = @("app.exe", "app.py", "templates\index.html", "static\app.js")
          $failed = $false
          foreach ($file in $required) {
            $p = Join-Path $dir $file
            if (Test-Path $p) { Write-Host "OK: $file" }
            else { Write-Host "MISSING: $file"; $failed = $true }
          }
          if ($failed) {
            Write-Host "Contents of ${dir}:"
            if (Test-Path $dir) { Get-ChildItem $dir -Recurse | ForEach-Object { Write-Host $_.FullName } }
            else { Write-Host "Directory does not exist!" }
            exit 1
          }
        shell: powershell

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: electron/dist/*.exe

  validate:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-installer

      - name: Install application silently
        run: |
          $installer = Get-ChildItem -Filter "*.exe" | Select-Object -First 1
          Write-Host "Installing $($installer.Name)..."
          Start-Process -FilePath $installer.FullName -ArgumentList "/S", "/D=C:\HoolggTest" -Wait
          Write-Host "Installation complete."
        shell: powershell

      - name: Verify file structure
        run: |
          $base = "C:\HoolggTest"
          $required = @(
            "resources\flask-app\app.exe",
            "resources\flask-app\app.py",
            "resources\flask-app\templates\index.html",
            "resources\flask-app\static\app.js",
            "resources\python\python.exe"
          )
          $failed = $false
          foreach ($file in $required) {
            $path = Join-Path $base $file
            if (Test-Path $path) {
              Write-Host "OK: $file"
            } else {
              Write-Host "MISSING: $file"
              $failed = $true
            }
          }
          if ($failed) {
            Write-Host ""
            Write-Host "Listing actual contents:"
            Get-ChildItem -Path $base -Recurse -Depth 3 | ForEach-Object {
              Write-Host $_.FullName.Replace($base, "")
            }
            exit 1
          }
        shell: powershell

      - name: Smoke test app.exe (PyInstaller bundle)
        run: |
          $env:HOOL_DATA_DIR = "$env:TEMP\hool-test-data"
          New-Item -ItemType Directory -Path $env:HOOL_DATA_DIR -Force | Out-Null

          $appExe = "C:\HoolggTest\resources\flask-app\app.exe"
          Write-Host "Starting app.exe..."
          $proc = Start-Process -FilePath $appExe -PassThru -WindowStyle Hidden

          $timeout = 15
          $ready = $false
          for ($i = 0; $i -lt $timeout; $i++) {
            Start-Sleep -Seconds 1
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:5000" -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "app.exe responded with HTTP 200 after $($i + 1)s"
                $ready = $true
                break
              }
            } catch {
              Write-Host "Waiting... ($($i + 1)s)"
            }
          }

          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 1

          if (-not $ready) {
            Write-Host "FAIL: app.exe did not respond on port 5000 within ${timeout}s"
            exit 1
          }
          Write-Host "PASS: app.exe smoke test succeeded"
        shell: powershell

      - name: Smoke test embedded Python fallback
        run: |
          $env:HOOL_DATA_DIR = "$env:TEMP\hool-test-data"
          New-Item -ItemType Directory -Path $env:HOOL_DATA_DIR -Force | Out-Null

          $pythonExe = "C:\HoolggTest\resources\python\python.exe"
          $appPy = "C:\HoolggTest\resources\flask-app\app.py"
          Write-Host "Starting embedded Python fallback..."
          $proc = Start-Process -FilePath $pythonExe -ArgumentList $appPy -PassThru -WindowStyle Hidden

          $timeout = 15
          $ready = $false
          for ($i = 0; $i -lt $timeout; $i++) {
            Start-Sleep -Seconds 1
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:5000" -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "Python fallback responded with HTTP 200 after $($i + 1)s"
                $ready = $true
                break
              }
            } catch {
              Write-Host "Waiting... ($($i + 1)s)"
            }
          }

          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 1

          if (-not $ready) {
            Write-Host "FAIL: Python fallback did not respond on port 5000 within ${timeout}s"
            exit 1
          }
          Write-Host "PASS: Embedded Python fallback smoke test succeeded"
        shell: powershell

  release:
    needs: [build, validate]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-installer

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.exe"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
